---
description: Swarm 模式服务的工作原理
keywords: docker, container, cluster, swarm mode, node
title: 服务的工作原理
weight: 20
---

在 Docker 引擎处于 Swarm 模式时，要部署应用程序镜像，你需要创建一个服务。通常，服务是某个较大应用程序上下文中的微服务镜像。服务的示例可能包括 HTTP 服务器、数据库或你希望在分布式环境中运行的任何其他类型的可执行程序。

当你创建服务时，你需要指定要使用的容器镜像以及在运行的容器内执行的命令。你还需要定义服务的选项，包括：

* Swarm 在外部访问服务的端口
* 服务用于连接 Swarm 中其他服务的覆盖网络
* CPU 和内存限制及预留
* 滚动更新策略
* 在 Swarm 中运行的镜像副本数量

## 服务、任务和容器

当你将服务部署到 Swarm 时，Swarm 管理员将你的服务定义作为服务的期望状态。然后它在 Swarm 的节点上调度服务，作为一个或多个副本任务。任务在 Swarm 的节点上独立运行。

例如，假设你希望在三个 HTTP 监听器实例之间进行负载均衡。下图显示了一个具有三个副本的 HTTP 监听器服务。监听器的三个实例中的每一个都是 Swarm 中的一个任务。

![具有三个副本的 HTTP 监听器服务](../images/services-diagram.webp?w=550)

容器是一个隔离的进程。在 Swarm 模式模型中，每个任务调用一个容器。任务类似于调度程序放置容器的“槽位”。一旦容器启动，调度程序就认为任务处于运行状态。如果容器未通过健康检查或终止，任务也会终止。

## 任务和调度

任务是 Swarm 内调度的基本单位。当你通过创建或更新服务来声明期望的服务状态时，协调器会通过调度任务来实现期望状态。例如，你定义一个服务，指示协调器始终运行三个 HTTP 监听器实例。协调器通过创建三个任务来响应。每个任务都是调度程序通过生成容器来填充的槽位。容器是任务的实例化。如果 HTTP 监听器任务随后未通过健康检查或崩溃，协调器会创建一个新的副本任务来生成新容器。

任务是单向机制。它单调地通过一系列状态：已分配、已准备、运行等。如果任务失败，协调器会移除任务及其容器，然后根据服务指定的期望状态创建新任务来替换它。

Docker Swarm 模式底层逻辑是一个通用的调度器和协调器。服务和任务抽象本身不知道它们实现的容器。理论上，你可以实现其他类型的任务，如虚拟机任务或非容器化进程任务。调度器和协调器对任务类型是无关的。但是，当前版本的 Docker 仅支持容器任务。

下图显示了 Swarm 模式如何接受服务创建请求并在工作节点上调度任务。

![服务流程](../images/service-lifecycle.webp?w=700)

### 挂起的服务

服务可能以某种方式配置，导致 Swarm 中当前没有节点可以运行其任务。在这种情况下，服务保持在 `pending` 状态。以下是服务可能保持在 `pending` 状态的几个示例。

> [!TIP]
> 如果你唯一的目标是防止服务被部署，将服务缩放为 0，而不是尝试以某种方式配置它使其保持在 `pending` 状态。

- 如果所有节点都暂停或被排空，而你创建了一个服务，它将保持在 `pending` 状态，直到有节点可用。实际上，第一个可用的节点会获得所有任务，所以这在生产环境中不是个好主意。

- 你可以为服务预留特定数量的内存。如果 Swarm 中没有节点具有所需的内存量，服务将保持在 `pending` 状态，直到有节点可以运行其任务。如果你指定一个非常大的值，比如 500 GB，任务将永远保持在 `pending` 状态，除非你真的有节点可以满足它。

- 你可以对服务施加位置约束，约束可能在给定时间无法被满足。

这种行为说明了任务的要求和配置与 Swarm 的当前状态没有紧密关联。作为 Swarm 的管理员，你声明 Swarm 的期望状态，管理器与 Swarm 中的节点协作来创建该状态。你不需要对 Swarm 上的任务进行微观管理。

## 副本和全局服务

有两种类型的服务部署：副本和全局。

对于副本服务，你指定要运行的相同任务数量。例如，你决定部署一个具有三个副本的 HTTP 服务，每个副本提供相同的内容。

全局服务是在每个节点上运行一个任务的服务。没有预指定的任务数量。每次你向 Swarm 添加节点时，协调器都会创建一个任务，调度程序将任务分配给新节点。全局服务的良好候选者是监控代理、反病毒扫描器或其他你希望在 Swarm 中每个节点上运行的容器类型。

下图显示了灰色的三个服务副本和黑色的全局服务。

![全局与副本服务](../images/replicated-vs-global.webp?w=450)

## 了解更多

* 阅读关于 Swarm 模式 [节点](nodes.md) 如何工作。
* 了解 Swarm 模式中的 [PKI](pki.md) 如何工作。