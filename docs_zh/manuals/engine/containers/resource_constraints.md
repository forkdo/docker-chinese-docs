---
title: 资源限制
weight: 30
description: 指定容器的运行时选项
keywords: docker, 守护进程, 配置, 运行时
aliases:
  - /engine/admin/resource_constraints/
  - /config/containers/resource_constraints/
---

默认情况下，容器没有资源限制，可以使用主机内核调度器允许的尽可能多的给定资源。Docker 提供了控制容器可以使用多少内存或 CPU 的方法，通过设置 `docker run` 命令的运行时配置标志。本节提供了何时应设置此类限制以及设置它们可能产生的影响的详细信息。

这些功能中的许多需要您的内核支持 Linux capabilities。要检查支持情况，您可以使用 [`docker info`](/reference/cli/docker/system/info.md) 命令。如果您的内核中禁用了某个 capability，您可能会在输出末尾看到如下警告：

```console
WARNING: No swap limit support
```

请查阅您操作系统文档以启用它们。另请参阅 [Docker Engine 故障排除指南](../daemon/troubleshoot.md#kernel-cgroup-swap-limit-capabilities) 了解更多信息。

## 内存

## 了解内存耗尽的风险

不应允许运行中的容器消耗过多主机内存，这一点很重要。在 Linux 主机上，如果内核检测到没有足够的内存执行重要系统功能，它会抛出 `OOME`（`Out Of Memory Exception`，内存溢出异常），并开始终止进程以释放内存。任何进程都可能被终止，包括 Docker 和其他重要应用程序。如果错误的进程被终止，这实际上可能导致整个系统崩溃。

Docker 试图通过调整 Docker 守护进程的 OOM 优先级来减轻这些风险，使其比系统上其他进程更不可能被终止。容器的 OOM 优先级不会被调整。这使得单个容器比 Docker 守护进程或其他系统进程更有可能被终止。您不应尝试通过在守护进程或容器上手动将 `--oom-score-adj` 设置为极端负数，或在容器上设置 `--oom-kill-disable` 来绕过这些保护措施。

有关 Linux 内核 OOM 管理的更多信息，请参阅 [内存溢出管理](https://www.kernel.org/doc/gorman/html/understand/understand016.html)。

您可以通过以下方式减轻因 OOME 导致系统不稳定的风险：

- 在将应用程序投入生产之前，执行测试以了解其内存需求。
- 确保您的应用程序仅在具有足够资源的主机上运行。
- 限制容器可以使用的内存量，如下所述。
- 配置 Docker 主机的交换空间时要小心。交换空间比内存慢，但可以在耗尽系统内存时提供缓冲。
- 考虑将您的容器转换为 [服务](/manuals/engine/swarm/services.md)，并使用服务级约束和节点标签确保应用程序仅在具有足够内存的主机上运行。

### 限制容器访问内存

Docker 可以强制执行硬性或软性内存限制。

- 硬性限制允许容器使用的内存量不超过固定值。
- 软性限制允许容器根据需要使用尽可能多的内存，除非满足某些条件，例如当内核检测到主机上的低内存或资源争用时。

其中一些选项单独使用或组合使用时效果不同。

这些选项中的大多数采用正整数，后跟 `b`、`k`、`m`、`g` 后缀，表示字节、千字节、兆字节或吉字节。

| 选项                 | 描述                                                                                                                                                                                                                                                                                                                                                                                     |
| :--------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `-m` 或 `--memory=`    | 容器可以使用的最大内存量。如果您设置此选项，允许的最小值为 `6m`（6 兆字节）。也就是说，您必须将值设置为至少 6 兆字节。                                                                                                                                                                                                           |
| `--memory-swap`\*      | 此容器允许交换到磁盘的内存量。参见 [`--memory-swap` 详细信息](#--memory-swap-details)。                                                                                                                                                                                                                                                                                                                                          |
| `--memory-swappiness`  | 默认情况下，主机内核可以交换容器使用的匿名页面的百分比。您可以将 `--memory-swappiness` 设置为 0 到 100 之间的值，以调整此百分比。参见 [`--memory-swappiness` 详细信息](#--memory-swappiness-details)。                                                                                                                                                                                                       |
| `--memory-reservation` | 允许您指定一个小于 `--memory` 的软限制，当 Docker 检测到主机上的资源争用或低内存时会激活此限制。如果您使用 `--memory-reservation`，它必须设置得比 `--memory` 低才能生效。因为它是软限制，所以不能保证容器不超过限制。                                                |
| `--kernel-memory`      | 容器可以使用的最大内存量。允许的最小值为 `6m`。因为内核内存无法被交换出去，内存不足的容器可能会阻塞主机资源，这可能对主机和其他容器产生副作用。参见 [`--kernel-memory` 详细信息](#--kernel-memory-details)。                                   |
| `--oom-kill-disable`   | 默认情况下，如果发生内存溢出 (OOM) 错误，内核会终止容器中的进程。要更改此行为，请使用 `--oom-kill-disable` 选项。仅在您也设置了 `-m/--memory` 选项的容器上禁用 OOM 终止器。如果未设置 `-m` 标志，主机可能会耗尽内存，内核可能需要终止主机系统的进程以释放内存。 |

有关 cgroups 和内存的一般信息，请参阅 [内存资源控制器](https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt) 文档。

### `--memory-swap` 详细信息

`--memory-swap` 是一个修饰符标志，只有在同时设置了 `--memory` 时才有意义。使用交换允许容器在容器耗尽所有可用 RAM 时将多余的内存需求写入磁盘。应用程序经常将内存交换到磁盘会有性能损失。

其设置可能有复杂的影响：

- 如果 `--memory-swap` 设置为正整数，则必须同时设置 `--memory` 和 `--memory-swap`。`--memory-swap` 表示可以使用的总内存和交换量，`--memory` 控制非交换内存的使用量。因此，如果 `--memory="300m"` 且 `--memory-swap="1g"`，容器可以使用 300m 内存和 700m（`1g - 300m`）交换。

- 如果 `--memory-swap` 设置为 `0`，则忽略该设置，该值被视为未设置。

- 如果 `--memory-swap` 设置为与 `--memory` 相同的值，且 `--memory` 设置为正整数，**容器无法访问交换**。参见 [防止容器使用交换](#prevent-a-container-from-using-swap)。

- 如果 `--memory-swap` 未设置，且 `--memory` 已设置，容器可以使用与 `--memory` 设置一样多的交换，如果主机容器配置了交换内存。例如，如果 `--memory="300m"` 且 `--memory-swap` 未设置，容器总共可以使用 600m 的内存和交换。

- 如果 `--memory-swap` 明确设置为 `-1`，容器允许使用无限交换，最多可达主机系统上可用的数量。

- 在容器内，`free` 等工具报告主机的可用交换，而不是容器内可用的交换。不要依赖 `free` 或类似工具的输出来确定是否存在交换。

#### 防止容器使用交换

如果 `--memory` 和 `--memory-swap` 设置为相同值，这会阻止容器使用任何交换。这是因为 `--memory-swap` 是可以使用的组合内存和交换总量，而 `--memory` 只是可以使用的物理内存量。

### `--memory-swappiness` 详细信息

- 值为 0 关闭匿名页面交换。
- 值为 100 将所有匿名页面设置为可交换。
- 默认情况下，如果您不设置 `--memory-swappiness`，该值从主机继承。

### `--kernel-memory` 详细信息

内核内存限制以分配给容器的总内存表示。考虑以下场景：

- **无限制内存，无限制内核内存**：这是默认行为。
- **无限制内存，限制内核内存**：当所有 cgroup 需要的内存量大于主机上实际存在的内存量时，这很合适。您可以配置内核内存，使其永远不会超过主机上可用的量，需要更多内存的容器需要等待。
- **限制内存，无限制内核内存**：总内存受限，但内核内存不受限。
- **限制内存，限制内核内存**：限制用户和内核内存对于调试内存相关问题很有用。如果容器使用了过多的任一类型内存，它会在影响其他容器或主机之前耗尽内存。在此设置内，如果内核内存限制低于用户内存限制，耗尽内核内存会导致容器遇到 OOM 错误。如果内核内存限制高于用户内存限制，内核限制不会导致容器遇到 OOM。

启用内核内存限制时，主机跟踪每个进程的“高水位线”统计信息，因此您可以跟踪哪些进程（在本例中为容器）正在使用过多内存。这可以通过查看主机上的 `/proc/<PID>/status` 按进程查看。

## CPU

默认情况下，每个容器对主机 CPU 周期的访问是无限制的。您可以设置各种约束来限制给定容器对主机 CPU 周期的访问。大多数用户使用和配置 [默认 CFS 调度器](#configure-the-default-cfs-scheduler)。您也可以配置 [实时调度器](#configure-the-real-time-scheduler)。

### 配置默认 CFS 调度器

CFS 是 Linux 内核 CPU 调度器，用于普通 Linux 进程。几个运行时标志允许您配置容器可以使用的 CPU 资源量。使用这些设置时，Docker 会修改主机上容器 cgroup 的设置。

| 选项                 | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `--cpus=<value>`       | 指定容器可以使用多少可用 CPU 资源。例如，如果主机有两颗 CPU，您设置 `--cpus="1.5"`，容器最多保证一颗半 CPU。这等同于设置 `--cpu-period="100000"` 和 `--cpu-quota="150000"`。                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `--cpu-period=<value>` | 指定 CPU CFS 调度器周期，与 `--cpu-quota` 一起使用。默认为 100000 微秒（100 毫秒）。大多数用户不会从此默认值更改。对于大多数用例，`--cpus` 是更方便的替代方案。                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `--cpu-quota=<value>`  | 对容器施加 CPU CFS 配额。在被限制之前，容器在每个 `--cpu-period` 内被限制的微秒数。因此作为有效上限。对于大多数用例，`--cpus` 是更方便的替代方案。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `--cpuset-cpus`        | 限制容器可以使用的特定 CPU 或核心。如果您有多个 CPU，可以使用逗号分隔列表或连字符分隔范围指定容器可以使用的 CPU。第一个 CPU 编号为 0。有效值可能是 `0-3`（使用第一、第二、第三和第四个 CPU）或 `1,3`（使用第二和第四个 CPU）。                                                                                                                                                                                                                                                                                                                                                                                                        |
| `--cpu-shares`         | 将此标志设置为大于或小于默认值 1024 的值，以增加或减少容器的权重，并使其能够获得更多或更少比例的主机 CPU 周期。这只在 CPU 周期受限时强制执行。当有充足的 CPU 周期可用时，所有容器都会使用它们需要的尽可能多的 CPU。这样，这是一个软限制。`--cpu-shares` 不会阻止容器在 Swarm 模式下被调度。它优先考虑容器 CPU 资源以获取可用的 CPU 周期。它不保证或保留任何特定的 CPU 访问。 |

如果您有 1 个 CPU，以下每个命令保证容器每秒最多 50% 的 CPU。

```console
$ docker run -it --cpus=".5" ubuntu /bin/bash
```

这等同于手动指定 `--cpu-period` 和 `--cpu-quota`；

```console
$ docker run -it --cpu-period=100000 --cpu-quota=50000 ubuntu /bin/bash
```

### 配置实时调度器

您可以配置容器使用实时调度器，用于无法使用 CFS 调度器的任务。在 [配置 Docker 守护进程](#configure-the-docker-daemon) 或 [配置单个容器](#configure-individual-containers) 之前，您需要 [确保主机内核配置正确](#configure-the-host-machines-kernel)。

> [!WARNING]
>
> CPU 调度和优先级是高级内核级功能。大多数用户不需要从默认值更改这些值。错误设置这些值可能导致主机系统变得不稳定或无法使用。

#### 配置主机内核

通过运行 `zcat /proc/config.gz | grep CONFIG_RT_GROUP_SCHED` 或检查文件 `/sys/fs/cgroup/cpu.rt_runtime_us` 是否存在，验证 `CONFIG_RT_GROUP_SCHED` 是否在 Linux 内核中启用。有关配置内核实时调度器的指导，请查阅您操作系统文档。

#### 配置 Docker 守护进程

要使用实时调度器运行容器，请使用 `--cpu-rt-runtime` 标志运行 Docker 守护进程，该标志设置为实时任务在运行时周期内保留的最大微秒数。例如，使用默认周期 1000000 微秒（1 秒），设置 `--cpu-rt-runtime=950000` 确保使用实时调度器的容器在每个 1000000 微秒周期内可以运行 950000 微秒，为非实时任务至少保留 50000 微秒。要在使用 `systemd` 的系统上永久配置此设置，为 `docker` 服务创建一个 systemd 单元文件。例如，参见如何使用 [systemd 单元文件](../daemon/proxy.md#systemd-unit-file) 配置守护进程使用代理的说明。

#### 配置单个容器

使用 `docker run` 启动容器时，您可以传递几个标志来控制容器的 CPU 优先级。查阅您操作系统文档或 `ulimit` 命令了解适当值的信息。

| 选项                     | 描述                                                                                                                                                                               |
| :------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `--cap-add=sys_nice`       | 授予容器 `CAP_SYS_NICE` capability，允许容器提升进程 `nice` 值、设置实时调度策略、设置 CPU 亲和性以及其他操作。 |
| `--cpu-rt-runtime=<value>` | 容器在 Docker 守护进程的实时调度器周期内可以以实时优先级运行的最大微秒数。您还需要 `--cap-add=sys_nice` 标志。        |
| `--ulimit rtprio=<value>`  | 容器允许的最大实时优先级。您还需要 `--cap-add=sys_nice` 标志。                                                                                    |

以下示例命令在 `debian:jessie` 容器上设置这三个标志。

```console
$ docker run -it \
    --cpu-rt-runtime=950000 \
    --ulimit rtprio=99 \
    --cap-add=sys_nice \
    debian:jessie
```

如果内核或 Docker 守护进程配置不正确，会发生错误。

## GPU

### 访问 NVIDIA GPU

#### 先决条件

访问官方 [NVIDIA 驱动页面](https://www.nvidia.com/Download/index.aspx) 下载并安装适当的驱动。安装完成后重启系统。

验证您的 GPU 正在运行且可访问。

#### 安装 nvidia-container-toolkit

按照官方 NVIDIA Container Toolkit [安装说明](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html) 操作。

#### 公开 GPU 供使用

启动容器时包含 `--gpus` 标志以访问 GPU 资源。指定要使用的 GPU 数量。例如：

```console
$ docker run -it --rm --gpus all ubuntu nvidia-smi
```

公开所有可用 GPU，返回类似以下的结果：

```bash
+-------------------------------------------------------------------------------+
| NVIDIA-SMI 384.130            	Driver Version: 384.130               	|
|-------------------------------+----------------------+------------------------+
| GPU  Name 	   Persistence-M| Bus-Id    	Disp.A | Volatile Uncorr. ECC   |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M.   |
|===============================+======================+========================|
|   0  GRID K520       	Off  | 00000000:00:03.0 Off |                  N/A      |
| N/A   36C	P0    39W / 125W |  	0MiB /  4036MiB |      0%  	Default |
+-------------------------------+----------------------+------------------------+
+-------------------------------------------------------------------------------+
| Processes:                                                       GPU Memory   |
|  GPU   	PID   Type   Process name                         	Usage  	|
|===============================================================================|
|  No running processes found                                                   |
+-------------------------------------------------------------------------------+
```

使用 `device` 选项指定 GPU。例如：

```console
$ docker run -it --rm --gpus device=GPU-3a23c669-1f69-c64e-cf85-44e9b07e7a2a ubuntu nvidia-smi
```

公开该特定 GPU。

```console
$ docker run -it --rm --gpus '"device=0,2"' ubuntu nvidia-smi
```

公开第一个和第三个 GPU。

> [!NOTE]
>
> NVIDIA GPU 